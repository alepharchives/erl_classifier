ERL = @ERL@
ERLC = @ERLC@
EBIN = ebin
MNESIA = datastore
NODENAME = @NODENAME@

dummy := $(shell test -d $(EBIN) || mkdir -p $(EBIN))
dummy := $(shell test -d $(MNESIA) || mkdir -p $(MNESIA))

compile: appfile
	@$(ERLC) +debug_info -v -W -DNOTEST -o $(EBIN) src/*.erl

compiletest: appfile
	@$(ERLC) +debug_info -v -W -DTEST -o $(EBIN) src/*.erl

appfile:
	@cp src/erl_classifier.app $(EBIN)

erl_classifier.boot:
	@echo "Create boot script..."
	@erl -noshell -pa $(EBIN) -eval 'systools:make_script("erl_classifier", [local])' -s init stop

eunit: compiletest
	@$(ERL) -noshell -pa $(EBIN) -mnesia dir '"$(MNESIA)"' -sname $(NODENAME) -eval 'mnesia:start(), eunit:test("$(EBIN)", [verbose])' -s init stop


console: compile
	@$(ERL) -boot erl_classifier -config sys -sname $(NODENAME)

ec.plt:
	dialyzer --build_plt -r . --output_plt ec.plt \
	  --apps sasl kernel stdlib erts mnesia

dialyzer: ec.plt
	dialyzer --plt ec.plt -r .

clean:
	@rm -Rf $(EBIN)/*.beam $(EBIN)/*.app
	@rm erl_classifier.boot erl_classifier.script
